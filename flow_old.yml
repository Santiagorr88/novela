# ╔══════════════════════════════════════════════════════════════╗
# ║  Deer‑flow – “Chronicles of the Sundering Judgment” (v1‑B)   ║
# ║  TODO en una sola raíz: prompts dentro de src/agents/        ║
# ╚══════════════════════════════════════════════════════════════╝
version: 1

variables:
  saga_title: "Chronicles_of_the_Sundering_Judgment"
  book_number: 1                   # ← súbelo a 2 cuando empiece el libro II
  chapter_prefix: "B{{book_number}}C"   # genera B1C, B2C…
  pdf_folder: "output/pdf"

flow:

# ───────────────────────── 1. Carga de lore ─────────────────────────
- id: lore_loader
  type: file_loader
  path: src/lore/prompt_universo.md           # ← prompt maestro ahora en src/lore/

# ──────────────────────── 2. Núm. de capítulo ───────────────────────
- id: chapter_number
  type: python
  module: scripts.memory_io
  function: next_chapter_number
  args:
    - "{{ variables.book_number }}"

# ───────────────────────── 3. Narrador (EN) ─────────────────────────
- id: narrator
  type: llm
  model: gemini-2.5-pro
  temperature: 0.75
  system_prompt_path: src/agents/narrator.md
  inputs:
    lore_context: "{{ lore_loader.content }}"
    chapter_no:  "{{ chapter_number.content }}"
    user_prompt: "{{ input }}"

# ─────────────────────── 4. Coherence‑editor ────────────────────────
- id: coherence_editor
  type: llm
  model: gemini-2.5-flash
  temperature: 0.3
  system_prompt_path: src/agents/coherence_editor.md
  inputs:
    lore_context: "{{ lore_loader.content }}"
    draft_chapter: "{{ narrator.content }}"

# ───── 4‑bis. Puerta: ¿hay fallos señalados? («FIX: …») ────────────
- id: fixer_gate
  type: router
  condition: "{{ coherence_editor.content.startswith('FIX') }}"

# ─────────────────────────── 5. Fixer ──────────────────────────────
- id: fixer
  when: "{{ fixer_gate }}"
  type: llm
  model: gemini-2.5-flash
  temperature: 0.5
  system_prompt_path: src/agents/fixer.md
  inputs:
    draft_chapter: "{{ narrator.content }}"
    issues: "{{ coherence_editor.content }}"


# ─────────────────── 6. Capítulo definitivo (EN) ───────────────────
- id: final_chapter
  type: passthrough
  inputs:
    content: "{{ fixer.content if fixer_gate else narrator.content }}"

# ───────────────────────── 7. Traductor (ES) ────────────────────────
- id: translator
  type: llm
  model: gemini-2.5-flash
  temperature: 0.2
  system_prompt_path: src/agents/translator.md
  inputs:
    english_text: "{{ final_chapter.content }}"

# ───────────── 8. Slug para nombres de archivo ─────────────
- id: title_slug
  type: python
  module: scripts.slugify
  function: make_slug
  inputs:
    text: |
      {{ final_chapter.content.splitlines()[0].split(':',1)[1].strip() }}

# ───────────── 9‑A. Exportación PDF (inglés) ─────────────
- id: pdf_en
  type: python
  module: scripts.export_pdf
  function: md_to_pdf
  inputs:
    markdown_text: "{{ final_chapter.content }}"
    filename: "cap_{{ chapter_number.content }}_{{ title_slug.content }}_EN"

# ───────────── 9‑B. Exportación PDF (español) ────────────
- id: pdf_es
  type: python
  module: scripts.export_pdf
  function: md_to_pdf
  inputs:
    markdown_text: "{{ translator.content }}"
    filename: "cap_{{ chapter_number.content }}_{{ title_slug.content }}_ES"

# ─────────────────── 10. Archivado en memoria ──────────────────────
- id: archivist
  type: python
  module: scripts.memory_io
  function: append_chapter
  inputs:
    text:    "{{ final_chapter.content }}"
    text_es: "{{ translator.content }}"

# ───────── 11‑A. Cuenta de capítulos para resumen ─────────
- id: chapter_count
  type: python
  module: scripts.memory_io
  function: chapter_count
  inputs: {}

# ───────── 11‑B. ¿Toca resumir (cada 5 caps)? ─────────────
- id: summarize_gate
  type: router
  condition: "{{ (chapter_count.content % 5) == 0 }}"

# ───────────────────────── 12. Summarizer ──────────────────────────
- id: summarizer
  when: "{{ summarize_gate }}"
  type: llm
  model: gemini-2.5-flash
  temperature: 0.2
  system_prompt_path: src/agents/summarizer.md
  inputs:
    text: "{{ final_chapter.content }}"
